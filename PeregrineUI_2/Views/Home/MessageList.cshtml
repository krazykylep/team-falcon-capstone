@*
Author   : Chinh T Cao        
Version  : 1.0.0
Date     : 1/11/2012
Copyright: Capstone Project Team Falcon 2011 All right reserved
*@

@model PeregrineUI_2.Models.PageData<PeregrineUI_2.Models.Message>

<script type="text/javascript">

    var msg_inquiry_current_page;
    var msg_inquiry_current_sort;

    /**/
    // Update page and sort val
    $(document).ready(function () {   
        msg_current_page = @(Model.CurrentPage);
        msg_current_sort = @(Model.SortingType);
    });

    /**/
    function Msg_inquiry_sorting(chkboxname) {
        // Getting the state of the chose checkbox
        var state = document.getElementById(chkboxname).checked;

        // If we check this checkbox, turnoff the other sorting checkbox
        if (state) {
            // Make ajax call to controller to update the table
            if (chkboxname == "Msg_inq_msg_id_sort")
                Msg_inquiry_collect_info(   "1",
                                            "1",
                                            document.getElementById("process_prio_input").value,
                                            document.getElementById("process_name_input").value );
            else if (chkboxname == "Msg_inq_context_sort")
                Msg_inquiry_collect_info(   "1",
                                            "2",
                                            document.getElementById("process_prio_input").value,
                                            document.getElementById("process_name_input").value );
            else if (chkboxname == "Msg_inq_name_sort")
                Msg_inquiry_collect_info(   "1",
                                            "3",
                                            document.getElementById("process_prio_input").value,
                                            document.getElementById("process_name_input").value );       
            else if (chkboxname == "Msg_inq_prio_sort")
                Msg_inquiry_collect_info(   "1",
                                            "4",
                                            document.getElementById("process_prio_input").value,
                                            document.getElementById("process_name_input").value );
            else if (chkboxname == "Msg_inq_date_sort")
                Msg_inquiry_collect_info(   "1",
                                            "5",
                                            document.getElementById("process_prio_input").value,
                                            document.getElementById("process_name_input").value );
            else
                alert("SORTING ERROR");
        }
        else {
            // We are not allowed all sorting checkbox uncheck
            document.getElementById(chkboxname).checked = true;
        }
    }

    // Show full message
    function showfullmsgdetail(msg_id) {          
        // Use ajax call to get the full message detail

        // Show to the window
        var content = msg_id;
        top.consoleRef = window.open('', 'myconsole',
                                        'width=350,height=250'
                                        + ',menubar=0'
                                        + ',toolbar=1'
                                        + ',status=0'
                                        + ',scrollbars=1'
                                        + ',resizable=1')
        top.consoleRef.document.writeln('<html><head><title>Console</title></head>'
                                            + '<body bgcolor=white onLoad="self.focus()">'
                                            + content
                                            + '</body></html>')
        top.consoleRef.document.close()
    }

    $(document).ready(function () {
        if ( @(Model.SortingType) == 1 )
            document.getElementById("Msg_inq_msg_id_sort").checked = true;
          else if ( @(Model.SortingType) == 2) 
            document.getElementById("Msg_inq_context_sort").checked = true;
        else if ( @(Model.SortingType) == 3) 
            document.getElementById("Msg_inq_name_sort").checked = true;     
        else if ( @(Model.SortingType) == 4) 
            document.getElementById("Msg_inq_prio_sort").checked = true;
        else if ( @(Model.SortingType) == 5) 
            document.getElementById("Msg_inq_date_sort").checked = true;
    });       
</script>

<table id ="msg_list_table" class="display">
        <thead>
            <tr>            
                <td>
                    Message ID 
                    <input id="Msg_inq_msg_id_sort" type="checkbox" onclick="Msg_inquiry_sorting(this.id)"/>            
                </td>
                <td>
                    Message Context 
                    <input id="Msg_inq_context_sort" type="checkbox" onclick="Msg_inquiry_sorting(this.id)"/>                 
                </td>
                <td>
                    Process Name 
                    <input id="Msg_inq_name_sort" type="checkbox" onclick="Msg_inquiry_sorting(this.id)"/>  
                </td>           
                <td>
                    Priority                    
                    <input id="Msg_inq_prio_sort" type="checkbox" onclick="Msg_inquiry_sorting(this.id)"/>   
                </td>
                <td>
                    Message Type
                </td>
                <td>
                    Date 
                    <input id="Msg_inq_date_sort" type="checkbox" onclick="Msg_inquiry_sorting(this.id)"/> 
                </td>
            </tr>
        </thead>     
        <tbody>
            @foreach (var message in Model.Data)
            {
                <tr>
                    <td> @message.MessageID.ToString() </td>                 
                    <td> <a class="msg_inquiry_process_id" href="javascript:void(0)" onclick="showfullmsgdetail(@(message.ProcessID))">@message.Content</a> </td>
                    <td>
                         <img src="..\..\Content\images\@(message.ProcessState.Trim()).png" alt=""/>
                         @message.ProcessName 
                    </td>
                    <td> @message.Priority.ToString() </td>
                    <td> @message.MsgType </td>
                    <td> @message.Date.ToString("yyyy-MM-dd HH:mm tt") 
                         <br /> ( : 
                         @( ((int)(DateTime.Now.Subtract(message.Date).TotalMinutes)).ToString()) minutes )
                    </td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <td colspan="4">
                    @{  // Pagination     

                        int start, end;

                        // Get the value of start and end based on the value of currpage and total number of page
                        if (Model.NumberOfPages <= 5)
                        {
                            // If the total number of page is less than 5, show all to user
                            start = 0;
                            end = Model.NumberOfPages;
                        }
                        else
                        {
                            // Else, allows user to choose first page, last page and 5 other page around current chose page
                            start = Model.CurrentPage - 2;
                            end = Model.CurrentPage + 2;

                            if (start < 1)
                            {
                                start = 1;
                                end = 5;
                            }
                            else if (end > Model.NumberOfPages)
                            {
                                start = Model.NumberOfPages - 4;
                                end = Model.NumberOfPages;
                            }
                        }

                        for (int i = 1; i <= Model.NumberOfPages; i++)
                        {
                            if (i < start)
                            {
                                if (i == 1)
                                {
                                    <a class="msg_inquiry_page-number" href="javascript:void(0)">@i</a>   
                                }
                                else
                                {
                                    <label>...</label>
                                    i = start - 1;
                                }
                            }
                            else if (i > end)
                            {
                                if (i == Model.NumberOfPages)
                                {
                                    <a class="msg_inquiry_page-number" href="javascript:void(0)">@i</a>
                                }
                                else
                                {
                                    <label>...</label>
                                    i = Model.NumberOfPages - 1;
                                }
                            }
                            else if (i == Model.CurrentPage)
                            {
                                @i
                            }
                            else
                            {
                                <a class="msg_inquiry_page-number" href="javascript:void(0)">@i</a>
                            }
                        }    
                                                               
                    }
                            
                    <label>|</label>
                    <label>Go to page:</label> 
                    <input  id="msg_inquiry_page_number" type="text" style="width: 40px" 
                            onchange="Msg_inquiry_collect_info  (     
                                                                    document.getElementById(this.id).value,
                                                                    msg_inquiry_current_sort,
                                                                    document.getElementById('process_prio_input').value,
                                                                    document.getElementById('process_name_input').value     
                                                                )" />
                                                                                                                                                                        
                </td>
            </tr>
        </tfoot>
</table>